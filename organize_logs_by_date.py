#!/usr/bin/env python
"""
Sort a flat directory of Darshan log files and put them into date-indexed
subdirectories.
"""

import os
import shutil
import datetime
import argparse

def move_logs_by_date(csv_file, index_fmt="%Y-%m", dryrun=False):
    """Move Darshan logs into date-indexed subdirectories

    Take a list of Darshan logs and their dates from the index generated by
    index_darshan_logs.py and move them into subdirectories indexed by date.

    Args:
        csv_file (str): Path to the index file generated by index_darshan_logs.py
        index_fmt (str): strftime-compatible string that defines the
            subdirectories into which Darshan logs should be sorted
        dryrun (bool): Print the sh-equivalent operations if True
    """
    with open(csv_file, 'r') as records:
        for line in records:
            if line.startswith('log_file'):
                # skip the header line
                continue
            logfile, datestr, _ = line.split(',', 2)
            date_dir = datetime.datetime.strptime(datestr, "%Y-%m-%d") \
                                        .strftime(index_fmt)
            if not os.path.isdir(date_dir):
                if dryrun:
                    print("mkdir %s" % date_dir)
                else:
                    os.mkdir(date_dir)
            if dryrun:
                print("mv %s %s/%s" % (logfile, date_dir, logfile))
            else:
                shutil.move(logfile, os.path.join(date_dir, logfile))

def main(argv=None):
    """CLI wrapper for move_logs_by_date

    Args:
        argv (list): List of command-line arguments if calling as a library; if
            None, fall through to sys.argv
    """
    parser = argparse.ArgumentParser(description='parse a darshan log')
    parser.add_argument('csv', type=str,
                        help='Index file in CSV format')
    parser.add_argument('--dryrun', action='store_true',
                        help='Only print file operations; do not move anything (default: False)')
    parser.add_argument('--index-format', type=str, default="%Y-%m",
                        help="strftime-compatible directory name template (default: %Y-%m)")
    args = parser.parse_args(argv)

    move_logs_by_date(csv_file=args.csv, index_fmt=args.index_format, dryrun=args.dryrun)

if __name__ == "__main__":
    main()
